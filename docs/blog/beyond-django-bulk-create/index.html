<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://malnossi.github.io/bulma.min.css">
    <link rel="stylesheet" href="https://malnossi.github.io/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnapp.websitepolicies.net/widgets/cookies/mzad7vzz.js" defer></script>
    <title>
Mohamed Nossirat | Fast &amp; Efficient Bulk Create with Django and PostgreSQL
</title>
</head>

<body>
    <nav class="navbar" role="navigation" aria-label="main navigation">
    <div class="navbar-brand">
        <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarBasicExample">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
    </div>

    <div class="navbar-menu" id="navbarBasicExample">
        <div class="navbar-end">
            <a class="navbar-item" href="/">Home</a>
            
            
                
                <a class="navbar-item" href="https://malnossi.github.io/blog/"> Blog</a>
            
        </div>
    </div>
    </div>

    <div class="navbar-end">
    </div>
    </div>
</nav>
<script>
    document.addEventListener('DOMContentLoaded', () => {
    
      // Get all "navbar-burger" elements
      const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);
    
      // Add a click event on each of them
      $navbarBurgers.forEach( el => {
        el.addEventListener('click', () => {
    
          // Get the target from the "data-target" attribute
          const target = el.dataset.target;
          const $target = document.getElementById(target);
    
          // Toggle the "is-active" class on both the "navbar-burger" and the "navbar-menu"
          el.classList.toggle('is-active');
          $target.classList.toggle('is-active');
    
        });
      });
    
    });
      </script>
    
    
<div class="section">
    <div class="card">
        <div class="card-image">
          <figure class="image is-16by9">
            <img
              src="/djangopostgres.png"
              alt="Placeholder image"
            />
          </figure>
        </div>
        <div class="card-content">
            <div class="level">
                <div class="level-item has-text-centered">
                    <div>
                        <h1 class="heading is-size-5"><strong>Fast &amp; Efficient Bulk Create with Django and PostgreSQL</strong></h1>
                        <div class="tags is-flex is-justify-content-center">
                            
                            <a class="tag is-link is-hoverable" href="/tags/django">#Django</a>
                            
                            <a class="tag is-link is-hoverable" href="/tags/postgresql">#PostgreSQL</a>
                            
                            <a class="tag is-link is-hoverable" href="/tags/data">#Data</a>
                            
                        </div>
                    </div>
                </div>
            </div>
          <div class="media">
            <div class="media-content">
              <span class="title is-size-6">Mohamed AL NOSSIRAT</span> |
              <time datetime="2025-10-30">30&#x2F;10&#x2F;2025</time>
              <hr/>
            </div>
            
          </div>
          <div class="content has-text-justified">
            <h2 id="introduction">Introduction</h2>
<p>At <a href="https://munityapps.com">Munity</a>, our entire mission revolves around one thing: connecting systems that were never meant to talk to each other. We live and breathe external API integrations pulling data from third-party platforms, transforming it, and making it usable inside modern applications. It sounds straightforward in theory. In practice, it’s controlled chaos.
Every integration comes with its own quirks. Some APIs are beautifully documented, versioned, and predictable. Others behave like relics from a forgotten era inconsistent, rate-limited, half-deprecated, and often missing the one endpoint we actually need. Authentication can range from simple bearer tokens to corporate-grade OAuth labyrinths that break every other week.
And when APIs aren’t available? That’s when the real plumbing begins. We’ve had to fetch data from exported CSVs, ancient FTP servers, even obscure vendor portals that only work in Internet Explorer (yes, still). The reality is that a “modern” integration stack often has to accommodate everything from sleek GraphQL APIs to legacy SOAP endpoints wrapped in enterprise duct tape.
So at Munity, we’ve learned to expect the unexpected. Our work isn’t just about writing connectors it’s about designing resilient systems that can handle inconsistency, scale gracefully, and adapt when external providers change their rules overnight.
In this post, I’ll dive into the common challenges we face building and maintaining these integrations the hidden complexity behind “just connecting an API,” and how we’ve built frameworks at Munity to keep the data flowing no matter how messy the source.</p>
<p>To provide a real-life, workable solution, we start every integration with a few assumptions ground rules that reflect how data actually behaves in the wild:</p>
<ol>
<li>
<p><strong>The Data is Fetched from a Remote Source</strong>
Whether it’s a REST API, S3 bucket, or a private FTP, the data always lives elsewhere. We don’t control its shape, format, or availability — but we must handle it reliably, regardless of latency, authentication quirks, or inconsistent delivery.</p>
</li>
<li>
<p><strong>The Data is Dirty and Needs to Be Transformed</strong>
Even the cleanest APIs leak edge cases. We expect malformed fields, missing relationships, duplicated records, and inconsistent types. Normalization, validation, and transformation aren’t “extra steps” they’re the core of the pipeline.</p>
</li>
<li>
<p><strong>The Data is Big</strong>
Real integrations don’t deal in kilobytes. They deal in gigabytes, sometimes terabytes. That means pagination, batching, streaming, and efficient storage aren’t nice-to-haves they’re essential for performance and scalability.</p>
</li>
</ol>
<p>With these realities in mind, we’ve built our internal frameworks and practices to make external data integration repeatable, predictable, and scalable no matter how messy the source or how complex the system on the other end.</p>
<h2 id="setup">Setup</h2>
<h3 id="the-external-api">The External API</h3>
<p>I will use the <a href="https://jsonplaceholder.typicode.com/photos">JSONPlaceholder</a>, it's a fake api and though we could mock an external API call</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">curl</span><span> https://jsonplaceholder.typicode.com/photos
</span></code></pre>
<pre data-lang="json" style="background-color:#2b303b;color:#c0c5ce;" class="language-json "><code class="language-json" data-lang="json"><span>[
</span><span>  {
</span><span>    &quot;</span><span style="color:#a3be8c;">albumId</span><span>&quot;: </span><span style="color:#d08770;">1</span><span>,
</span><span>    &quot;</span><span style="color:#a3be8c;">id</span><span>&quot;: </span><span style="color:#d08770;">1</span><span>,
</span><span>    &quot;</span><span style="color:#a3be8c;">title</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">accusamus beatae ad facilis cum similique qui sunt</span><span>&quot;,
</span><span>    &quot;</span><span style="color:#a3be8c;">url</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">https://via.placeholder.com/600/92c952</span><span>&quot;,
</span><span>    &quot;</span><span style="color:#a3be8c;">thumbnailUrl</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">https://via.placeholder.com/150/92c952</span><span>&quot;
</span><span>  },
</span><span>  {
</span><span>    &quot;</span><span style="color:#a3be8c;">albumId</span><span>&quot;: </span><span style="color:#d08770;">1</span><span>,
</span><span>    &quot;</span><span style="color:#a3be8c;">id</span><span>&quot;: </span><span style="color:#d08770;">2</span><span>,
</span><span>    &quot;</span><span style="color:#a3be8c;">title</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">reprehenderit est deserunt velit ipsam</span><span>&quot;,
</span><span>    &quot;</span><span style="color:#a3be8c;">url</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">https://via.placeholder.com/600/771796</span><span>&quot;,
</span><span>    &quot;</span><span style="color:#a3be8c;">thumbnailUrl</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">https://via.placeholder.com/150/771796</span><span>&quot;
</span><span>  },
</span><span>  </span><span style="color:#65737e;">//
</span><span>]
</span></code></pre>
<h3 id="project-setup">Project Setup</h3>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">mkdir</span><span> djangopostgres &amp;&amp; </span><span style="color:#96b5b4;">cd</span><span> djangopostgres
</span><span style="color:#bf616a;">uv</span><span> init .
</span><span style="color:#bf616a;">uv</span><span> add django psycopg2-binary
</span><span style="color:#bf616a;">uv</span><span> run django-admin create-project config .
</span></code></pre>
<h3 id="docker-for-the-postgresql-database">Docker for the PostgreSQL Database</h3>
<pre data-lang="yml" style="background-color:#2b303b;color:#c0c5ce;" class="language-yml "><code class="language-yml" data-lang="yml"><span style="color:#bf616a;">services</span><span>:
</span><span>  </span><span style="color:#bf616a;">db</span><span>:
</span><span>    </span><span style="color:#bf616a;">image</span><span>: </span><span style="color:#a3be8c;">postgres:18
</span><span>    </span><span style="color:#bf616a;">ports</span><span>:
</span><span>      - </span><span style="color:#a3be8c;">5432:5432
</span><span>    </span><span style="color:#bf616a;">environment</span><span>:
</span><span>      - </span><span style="color:#a3be8c;">POSTGRES_USER=test
</span><span>      - </span><span style="color:#a3be8c;">POSTGRES_PASSWORD=test
</span><span>      - </span><span style="color:#a3be8c;">POSTGRES_DB=django
</span><span>
</span></code></pre>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">docker</span><span> compsoe up</span><span style="color:#bf616a;"> -d
</span></code></pre>
<p>In the project's <code>settings.py</code> file change the <code>DATABASES</code> dict as follwing:</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span>
</span><span style="color:#bf616a;">DATABASES </span><span>= {
</span><span>    &quot;</span><span style="color:#a3be8c;">default</span><span>&quot;: {
</span><span>        &quot;</span><span style="color:#a3be8c;">ENGINE</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">django.db.backends.postgresql</span><span>&quot;,
</span><span>        &quot;</span><span style="color:#a3be8c;">NAME</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">django</span><span>&quot;,
</span><span>        &quot;</span><span style="color:#a3be8c;">USER</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">test</span><span>&quot;,
</span><span>        &quot;</span><span style="color:#a3be8c;">PASSWORD</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">test</span><span>&quot;,
</span><span>        &quot;</span><span style="color:#a3be8c;">HOST</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">localhost</span><span>&quot;,
</span><span>        &quot;</span><span style="color:#a3be8c;">PORT</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">5432</span><span>&quot;,
</span><span>    }
</span><span>}
</span></code></pre>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">python</span><span> manage.py startapp photos
</span></code></pre>
<p>Add the <code>photos</code>app to the Django's <code>INSTALLED_APPS</code></p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#bf616a;">INSTALLED_APPS </span><span>= [
</span><span>    &quot;</span><span style="color:#a3be8c;">django.contrib.admin</span><span>&quot;,
</span><span>    &quot;</span><span style="color:#a3be8c;">django.contrib.auth</span><span>&quot;,
</span><span>    &quot;</span><span style="color:#a3be8c;">django.contrib.contenttypes</span><span>&quot;,
</span><span>    &quot;</span><span style="color:#a3be8c;">django.contrib.sessions</span><span>&quot;,
</span><span>    &quot;</span><span style="color:#a3be8c;">django.contrib.messages</span><span>&quot;,
</span><span>    &quot;</span><span style="color:#a3be8c;">django.contrib.staticfiles</span><span>&quot;,
</span><span>    &quot;</span><span style="color:#a3be8c;">photos</span><span>&quot;, </span><span style="color:#65737e;"># new
</span><span>]
</span></code></pre>
<p>And modify in the <code>photos</code> application <code>models.py</code> as folllowing:</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">from </span><span>django.db </span><span style="color:#b48ead;">import </span><span>models
</span><span>
</span><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">Photo</span><span style="color:#eff1f5;">(</span><span style="color:#a3be8c;">models.Model</span><span style="color:#eff1f5;">):
</span><span>
</span><span>    title = models.</span><span style="color:#bf616a;">CharField</span><span>(</span><span style="color:#bf616a;">max_length</span><span>=</span><span style="color:#d08770;">255</span><span>)
</span><span>    url = models.</span><span style="color:#bf616a;">URLField</span><span>(</span><span style="color:#bf616a;">max_length</span><span>=</span><span style="color:#d08770;">255</span><span>)
</span><span>    raw_data = models.</span><span style="color:#bf616a;">JSONField</span><span>(</span><span style="color:#bf616a;">default</span><span>=dict)
</span><span>    created = models.</span><span style="color:#bf616a;">DateTimeField</span><span>(</span><span style="color:#bf616a;">auto_now_add</span><span>=</span><span style="color:#d08770;">True</span><span>)
</span><span>    updated = models.</span><span style="color:#bf616a;">DateTimeField</span><span>(</span><span style="color:#bf616a;">auto_now</span><span>=</span><span style="color:#d08770;">True</span><span>)
</span><span>
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">Meta</span><span style="color:#eff1f5;">:
</span><span>        db_table = &quot;</span><span style="color:#a3be8c;">photos</span><span>&quot;
</span></code></pre>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">python</span><span> manage.py makemigraions
</span><span style="color:#bf616a;">python</span><span> manage.py migrate
</span><span>
</span></code></pre>
<p>For this article, I will implement the features in the “management commands” file, but you can imagine that these functions could live in a Celery task or in a gRPC service. for further information about Django's management commands please refer to the <a href="https://docs.djangoproject.com/en/5.2/howto/custom-management-commands/">Documentation</a></p>
<h3 id="fetch-the-photos-from-the-api">Fetch the photos from the API</h3>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">import </span><span>requests
</span><span style="color:#b48ead;">from </span><span>typing </span><span style="color:#b48ead;">import </span><span>Iterator, Dict, Any
</span><span>
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">get_photos</span><span>() -&gt; Iterator[Dict[str, Any]]:
</span><span>    session = requests.</span><span style="color:#bf616a;">Session</span><span>()
</span><span>    response = session.</span><span style="color:#bf616a;">get</span><span>(&quot;</span><span style="color:#a3be8c;">https://jsonplaceholder.typicode.com/photos</span><span>&quot;)
</span><span>    response.</span><span style="color:#bf616a;">raise_for_status</span><span>()
</span><span>    </span><span style="color:#b48ead;">yield from </span><span>response.</span><span style="color:#bf616a;">json</span><span>()
</span></code></pre>
<h3 id="profile-decorator">Profile decorator</h3>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">profile</span><span>(</span><span style="color:#bf616a;">fn</span><span>):
</span><span>    @</span><span style="color:#bf616a;">wraps</span><span>(fn)
</span><span>    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">inner</span><span>(*</span><span style="color:#bf616a;">args</span><span>, **</span><span style="color:#bf616a;">kwargs</span><span>):
</span><span>        </span><span style="color:#96b5b4;">print</span><span>(</span><span style="color:#b48ead;">f</span><span>&quot;</span><span style="color:#96b5b4;">\n</span><span>{fn.__name__}&quot;)
</span><span>        tracemalloc.</span><span style="color:#bf616a;">start</span><span>()
</span><span>        t0 = time.</span><span style="color:#bf616a;">perf_counter</span><span>()
</span><span>        </span><span style="color:#b48ead;">try</span><span>:
</span><span>            </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">fn</span><span>(*args, **kwargs)
</span><span>        </span><span style="color:#b48ead;">finally</span><span>:
</span><span>            elapsed = time.</span><span style="color:#bf616a;">perf_counter</span><span>() - t0
</span><span>            current, peak = tracemalloc.</span><span style="color:#bf616a;">get_traced_memory</span><span>()
</span><span>            tracemalloc.</span><span style="color:#bf616a;">stop</span><span>()
</span><span>            </span><span style="color:#96b5b4;">print</span><span>(</span><span style="color:#b48ead;">f</span><span>&quot;</span><span style="color:#a3be8c;">Time   </span><span>{elapsed</span><span style="color:#d08770;">:0.4f</span><span>}</span><span style="color:#a3be8c;">s</span><span>&quot;)
</span><span>            </span><span style="color:#96b5b4;">print</span><span>(</span><span style="color:#b48ead;">f</span><span>&quot;</span><span style="color:#a3be8c;">Memory </span><span>{peak / (</span><span style="color:#d08770;">1024</span><span>**</span><span style="color:#d08770;">2</span><span>)</span><span style="color:#d08770;">:.3f</span><span>}</span><span style="color:#a3be8c;"> MiB (peak)</span><span>&quot;)
</span><span>
</span><span>    </span><span style="color:#b48ead;">return </span><span>inner
</span></code></pre>
<p>This <code>@profile</code> decorator is a lightweight performance tool that measures how long a function takes to run and how much memory it consumes at its peak. It uses Python’s built-in <code>tracemalloc</code> module to track memory allocations and <code>time.perf_counter()</code> for precise timing. When applied to a function, it starts monitoring before execution, runs the function once, and then reports the total execution time and maximum memory usage in a clean, readable format. It helps identify performance bottlenecks and memory inefficiencies without requiring external profilers.</p>
<h3 id="implemntation">Implemntation</h3>
<p>Currently, the Jsonplaceholder Photos API only contains 5,000 entries, so to work with a large dataset, I will multiply the list by 100, giving us 500K entries.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span>&gt;&gt;&gt; photos = </span><span style="color:#bf616a;">list</span><span>(get_photos())</span><span style="color:#bf616a;">*100
</span><span>&gt;&gt;&gt; len(</span><span style="color:#bf616a;">photos</span><span>)
</span><span style="color:#bf616a;">500000
</span></code></pre>
<h3 id="django-orm-bulk-create">Django ORM Bulk Create</h3>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span>@</span><span style="color:#bf616a;">profile
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">insert_django_bulk_create</span><span>(</span><span style="color:#bf616a;">photos</span><span>: Iterator[Dict[str, Any]]):
</span><span>
</span><span>    Photo.objects.</span><span style="color:#bf616a;">bulk_create</span><span>(
</span><span>        [
</span><span>            </span><span style="color:#bf616a;">Photo</span><span>(**</span><span style="color:#bf616a;">dict</span><span>(</span><span style="color:#bf616a;">title</span><span>=photo[&quot;</span><span style="color:#a3be8c;">title</span><span>&quot;], </span><span style="color:#bf616a;">url</span><span>=photo[&quot;</span><span style="color:#a3be8c;">url</span><span>&quot;], </span><span style="color:#bf616a;">raw_data</span><span>=photo))
</span><span>            </span><span style="color:#b48ead;">for </span><span>photo </span><span style="color:#b48ead;">in </span><span>photos
</span><span>        ],
</span><span>    )
</span></code></pre>
<p>For this we will have a commande in <code>load_data.py</code>file:</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">Command</span><span style="color:#eff1f5;">(</span><span style="color:#a3be8c;">BaseCommand</span><span style="color:#eff1f5;">):
</span><span>    </span><span style="color:#96b5b4;">help </span><span>= &quot;</span><span style="color:#a3be8c;">Load Data from External API</span><span>&quot;
</span><span>
</span><span>    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">handle</span><span>(</span><span style="color:#bf616a;">self</span><span>, *</span><span style="color:#bf616a;">args</span><span>, **</span><span style="color:#bf616a;">options</span><span>):
</span><span>        </span><span style="color:#bf616a;">insert_django_bulk_create</span><span>(</span><span style="color:#bf616a;">photos</span><span>=photos)
</span><span>        </span><span style="color:#bf616a;">self</span><span>.stdout.</span><span style="color:#bf616a;">write</span><span>(</span><span style="color:#bf616a;">self</span><span>.style.</span><span style="color:#bf616a;">SUCCESS</span><span>(&quot;</span><span style="color:#a3be8c;">Successfully Loaded Data to Photos</span><span>&quot;))
</span></code></pre>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">python</span><span> manage.py load_data
</span><span>
</span><span style="color:#bf616a;">insert_django_bulk_create
</span><span style="color:#bf616a;">Time</span><span>   45.0054s
</span><span style="color:#bf616a;">Memory</span><span> 627.871 MiB (peak)
</span><span style="color:#bf616a;">Successfully</span><span> Loaded Data to Photos
</span></code></pre>
<p>The profiling results show that the <code>insert_django_bulk_create</code> function took <strong>45 seconds</strong> to execute and used up to <strong>627.87 MB</strong> of memory at its peak. This indicates that while Django’s <code>bulk_create</code> method efficiently reduces the number of database insert queries, it still consumes a significant amount of memory because all the <code>Photo</code> objects are instantiated and held in memory before being written to the database. Such a large memory footprint and relatively long execution time suggest that this approach may not scale well for very large datasets.</p>
<h3 id="copy">COPY</h3>
<p>The official PostgreSQL documentation includes a dedicated section on Populating a Database, which highlights that the most efficient method for loading large amounts of data is the <code>COPY</code> command. In Python, the <code>psycopg</code> library offers a convenient interface for this through the <code>copy_from</code> function. Since the COPY command works with CSV input, the idea is to first convert our dataset into a CSV format and then use copy_from to stream the data directly into the database, the Django’s underlying database connection cursor will have <code>copy_from</code>, <code>copy_to</code>, and <code>copy_expert</code> methods available. You can read their full API <a href="https://www.psycopg.org/docs/usage.html#using-copy-to-and-copy-from">documentation</a>.</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">import </span><span>io
</span><span>@</span><span style="color:#bf616a;">profile
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">insert_string_io</span><span>(</span><span style="color:#bf616a;">photos</span><span>: Iterator[Dict[str, Any]]):
</span><span>    columns = (&quot;</span><span style="color:#a3be8c;">title</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">url</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">raw_data</span><span>&quot;)
</span><span>    csv_file_like_object = io.</span><span style="color:#bf616a;">StringIO</span><span>()
</span><span>    </span><span style="color:#b48ead;">for </span><span>photo </span><span style="color:#b48ead;">in </span><span>photos:
</span><span>        csv_file_like_object.</span><span style="color:#bf616a;">write</span><span>(
</span><span>            &quot;</span><span style="color:#a3be8c;">|</span><span>&quot;.</span><span style="color:#bf616a;">join</span><span>((photo[&quot;</span><span style="color:#a3be8c;">title</span><span>&quot;], photo[&quot;</span><span style="color:#a3be8c;">url</span><span>&quot;], json.</span><span style="color:#bf616a;">dumps</span><span>(photo))) + &quot;</span><span style="color:#96b5b4;">\n</span><span>&quot;
</span><span>        )
</span><span>    csv_file_like_object.</span><span style="color:#bf616a;">seek</span><span>(</span><span style="color:#d08770;">0</span><span>)
</span><span>    </span><span style="color:#b48ead;">with </span><span>connection.</span><span style="color:#bf616a;">cursor</span><span>() </span><span style="color:#b48ead;">as </span><span>cursor:
</span><span>        cursor.</span><span style="color:#bf616a;">copy_from</span><span>(csv_file_like_object, &quot;</span><span style="color:#a3be8c;">photos</span><span>&quot;, </span><span style="color:#bf616a;">sep</span><span>=&quot;</span><span style="color:#a3be8c;">|</span><span>&quot;, </span><span style="color:#bf616a;">columns</span><span>=columns)
</span></code></pre>
<p>Change the code in <code>load_data.py</code>file:</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">Command</span><span style="color:#eff1f5;">(</span><span style="color:#a3be8c;">BaseCommand</span><span style="color:#eff1f5;">):
</span><span>    </span><span style="color:#96b5b4;">help </span><span>= &quot;</span><span style="color:#a3be8c;">Load Data from External API</span><span>&quot;
</span><span>
</span><span>    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">handle</span><span>(</span><span style="color:#bf616a;">self</span><span>, *</span><span style="color:#bf616a;">args</span><span>, **</span><span style="color:#bf616a;">options</span><span>):
</span><span>        </span><span style="color:#65737e;"># insert_django_bulk_create(photos=photos)
</span><span>        </span><span style="color:#bf616a;">insert_string_io</span><span>(</span><span style="color:#bf616a;">photos</span><span>=photos)
</span><span>        </span><span style="color:#bf616a;">self</span><span>.stdout.</span><span style="color:#bf616a;">write</span><span>(</span><span style="color:#bf616a;">self</span><span>.style.</span><span style="color:#bf616a;">SUCCESS</span><span>(&quot;</span><span style="color:#a3be8c;">Successfully Loaded Data to Photos</span><span>&quot;))
</span></code></pre>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">python</span><span> manage.py load_data
</span><span>
</span><span style="color:#bf616a;">psycopg2.errors.NotNullViolation:</span><span> null value in column &quot;</span><span style="color:#a3be8c;">created</span><span>&quot; of relation &quot;</span><span style="color:#a3be8c;">photos</span><span>&quot; violates not-null constraint
</span><span style="color:#bf616a;">DETAIL:</span><span>  Failing row contains (5001, accusamus beatae ad facilis cum similique qui sunt, https://via.placeholder.com/600/92c952, {&quot;</span><span style="color:#a3be8c;">id</span><span>&quot;: 1, &quot;</span><span style="color:#a3be8c;">url</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">https://via.placeholder.com/600/92c952</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">titl..., null, null).
</span><span style="color:#a3be8c;">CONTEXT:  COPY photos, line 1: </span><span>&quot;accusamus beatae ad facilis cum similique qui sunt|https://via.placeholder.com/600/92c952|{&quot;</span><span style="color:#a3be8c;">albumId</span><span>&quot;...&quot;
</span></code></pre>
<p>The message is clear: we are trying to insert values into the database without specifying the values for the <code>created</code> and <code>updated</code> columns, thereby violating the <code>not-null</code> constraint. However, if we look at the code in our <code>Photo</code> model, we see that we have added the two parameters <code>auto_now=True</code> and <code>auto_now_add=True</code>. Why is this happening?</p>
<pre data-lang="py" style="background-color:#2b303b;color:#c0c5ce;" class="language-py "><code class="language-py" data-lang="py"><span style="color:#b48ead;">from </span><span>django.db </span><span style="color:#b48ead;">import </span><span>models
</span><span>
</span><span>
</span><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">Photo</span><span style="color:#eff1f5;">(</span><span style="color:#a3be8c;">models.Model</span><span style="color:#eff1f5;">):
</span><span>	</span><span style="color:#65737e;"># //code
</span><span>    created = models.</span><span style="color:#bf616a;">DateTimeField</span><span>(</span><span style="color:#bf616a;">auto_now_add</span><span>=</span><span style="color:#d08770;">True</span><span>) </span><span style="color:#65737e;"># here
</span><span>    updated = models.</span><span style="color:#bf616a;">DateTimeField</span><span>(</span><span style="color:#bf616a;">auto_now</span><span>=</span><span style="color:#d08770;">True</span><span>) </span><span style="color:#65737e;"># here
</span><span>
</span><span>	</span><span style="color:#65737e;"># //code
</span></code></pre>
<blockquote>
<p>The field is only automatically updated when calling <code>Model.save()</code>. The field isn’t updated when making updates to other fields in other ways such as <code>QuerySet.update()</code>, though you can specify a custom value for the field in an update like that.</p>
</blockquote>
<p>When you call Model.save(), Django runs extra Python logic, like automatically updating auto_now or auto_now_add fields, running model signals <code>pre_save</code>, <code>post_save</code>, and handling field defaults. However, when you use <code>QuerySet.update()</code>, Django bypasses all of that and sends a direct <code>SQL UPDATE</code> to the database without calling <code>.save()</code> on each object. Because of that, the database itself doesn’t know about Django’s automatic updates it just updates the specified columns. So the rule is: the auto-update behavior is controlled by Django’s model system in Python, not by the database engine.</p>
<p>We can verify this by looking at the SQL code that was generated by the migration.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">python</span><span> manage.py sqlmigrate photos 0001  
</span></code></pre>
<pre data-lang="sql" style="background-color:#2b303b;color:#c0c5ce;" class="language-sql "><code class="language-sql" data-lang="sql"><span style="color:#b48ead;">BEGIN</span><span>;
</span><span style="color:#65737e;">--
</span><span style="color:#65737e;">-- Create model Photo
</span><span style="color:#65737e;">--
</span><span style="color:#b48ead;">CREATE TABLE </span><span>&quot;</span><span style="color:#8fa1b3;">photos</span><span>&quot; (
</span><span>	&quot;</span><span style="color:#a3be8c;">id</span><span>&quot; </span><span style="color:#b48ead;">bigint </span><span>NOT </span><span style="color:#d08770;">NULL </span><span style="color:#b48ead;">PRIMARY KEY</span><span> GENERATED BY </span><span style="color:#b48ead;">DEFAULT </span><span>AS IDENTITY, 
</span><span>	&quot;</span><span style="color:#a3be8c;">title</span><span>&quot; </span><span style="color:#b48ead;">varchar</span><span>(</span><span style="color:#d08770;">255</span><span>) NOT </span><span style="color:#d08770;">NULL</span><span>, 
</span><span>	&quot;</span><span style="color:#a3be8c;">url</span><span>&quot; </span><span style="color:#b48ead;">varchar</span><span>(</span><span style="color:#d08770;">255</span><span>) NOT </span><span style="color:#d08770;">NULL</span><span>, 
</span><span>	&quot;</span><span style="color:#a3be8c;">raw_data</span><span>&quot; jsonb NOT </span><span style="color:#d08770;">NULL</span><span>, 
</span><span>	&quot;</span><span style="color:#a3be8c;">created</span><span>&quot; </span><span style="color:#b48ead;">timestamp with time zone </span><span>NOT </span><span style="color:#d08770;">NULL</span><span>, 
</span><span>	&quot;</span><span style="color:#a3be8c;">updated</span><span>&quot; </span><span style="color:#b48ead;">timestamp with time zone </span><span>NOT </span><span style="color:#d08770;">NULL
</span><span>	);
</span><span style="color:#b48ead;">COMMIT</span><span>;
</span></code></pre>
<p>As you can see, the two columns <code>created</code> and <code>updated</code> have the <code>NOT NULL</code> constraint, but there is nothing to indicate that we want the database to fill them with a default value.</p>
<p>To solve this problem, we have two solutions:</p>
<ol>
<li>Explicitly set these two values in our Python code.</li>
<li>Change the SQL code generated by my migration to automatically add these two values to the database.</li>
</ol>
<h4 id="1-explicitly-set-values-in-python-code">1- Explicitly set values in Python code.</h4>
<p>In the Django documentation we can see this in the section of <a href="https://docs.djangoproject.com/en/5.2/ref/models/fields/#datefield">DateField</a></p>
<blockquote>
<strong>DateField.auto_now_add</strong>
<p>Automatically set the field to now when the object is first created. Useful for creation of timestamps. Note that the current date is always used; it’s not just a default value that you can override. So even if you set a value for this field when creating the object, it will be ignored. If you want to be able to modify this field, set the following instead of <code>auto_now_add=True</code>:</p>
<ul>
<li>For DateField: <code>default=date.today</code> - from <code>datetime.date.today()</code></li>
<li>For DateTimeField: <code>default=timezone.now</code> - from <code>django.utils.timezone.now()</code></li>
</ul>
</blockquote>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">import </span><span>io
</span><span style="color:#b48ead;">import </span><span>json
</span><span style="color:#b48ead;">from </span><span>django.db </span><span style="color:#b48ead;">import </span><span>connection
</span><span style="color:#b48ead;">from </span><span>django.utils </span><span style="color:#b48ead;">import </span><span>timezone  </span><span style="color:#65737e;"># new
</span><span style="color:#b48ead;">from </span><span>typing </span><span style="color:#b48ead;">import </span><span>Iterator, Dict, Any
</span><span>
</span><span>@</span><span style="color:#bf616a;">profile
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">insert_string_io</span><span>(</span><span style="color:#bf616a;">photos</span><span>: Iterator[Dict[str, Any]]):
</span><span>    columns = (&quot;</span><span style="color:#a3be8c;">title</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">url</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">raw_data</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">created</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">updated</span><span>&quot;)
</span><span>    csv_file_like_object = io.</span><span style="color:#bf616a;">StringIO</span><span>()
</span><span>    now = timezone.</span><span style="color:#bf616a;">now</span><span>().</span><span style="color:#bf616a;">isoformat</span><span>() </span><span style="color:#65737e;"># new
</span><span>    </span><span style="color:#b48ead;">for </span><span>photo </span><span style="color:#b48ead;">in </span><span>photos:
</span><span>        csv_file_like_object.</span><span style="color:#bf616a;">write</span><span>(
</span><span>            &quot;</span><span style="color:#a3be8c;">|</span><span>&quot;.</span><span style="color:#bf616a;">join</span><span>((photo[&quot;</span><span style="color:#a3be8c;">title</span><span>&quot;], photo[&quot;</span><span style="color:#a3be8c;">url</span><span>&quot;], json.</span><span style="color:#bf616a;">dumps</span><span>(photo), now, now)) + &quot;</span><span style="color:#96b5b4;">\n</span><span>&quot;
</span><span>        )
</span><span>    csv_file_like_object.</span><span style="color:#bf616a;">seek</span><span>(</span><span style="color:#d08770;">0</span><span>)
</span><span>    </span><span style="color:#b48ead;">with </span><span>connection.</span><span style="color:#bf616a;">cursor</span><span>() </span><span style="color:#b48ead;">as </span><span>cursor:
</span><span>        cursor.</span><span style="color:#bf616a;">copy_from</span><span>(csv_file_like_object, &quot;</span><span style="color:#a3be8c;">photos</span><span>&quot;, </span><span style="color:#bf616a;">sep</span><span>=&quot;</span><span style="color:#a3be8c;">|</span><span>&quot;, </span><span style="color:#bf616a;">columns</span><span>=columns)
</span></code></pre>
<p>Now run the script again</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">python</span><span> manage.py load_data
</span><span>
</span><span style="color:#bf616a;">insert_string_io
</span><span style="color:#bf616a;">Time</span><span>   9.8585s
</span><span style="color:#bf616a;">Memory</span><span> 793.827 MiB (peak)
</span></code></pre>
<p>So, we have a slight improvement in execution time compared to the <code>bulk_create</code> version, but we are consuming more memory. The <code>insert_string_io</code> function was executed, it took approximately <strong>10</strong> seconds to complete and used about <strong>793.83</strong> megabytes of memory at its highest point during execution. Which suggests that the function was handling a large amount of data in memory (buffering a big CSV) before writing or inserting it.</p>
<h4 id="2-change-the-sql-code-generated-by-my-migration">2- Change the SQL code generated by my migration</h4>
<p>You can safely add the SQL changes (like adding DEFAULT CURRENT_TIMESTAMP or creating an update trigger) in a separate migration file such as 0002_auto_add_timestamps.py.
That’s actually the <strong>best practice</strong>, because you keep Django’s auto-generated schema (0001_initial.py) clean and version-controlled by Django, while your custom SQL lives in a clearly separate migration.</p>
<p>Create a <code>0002_auto_add_timestamps.py</code>file unser the <code>photos/migrations</code> folder and modify it as follwing:</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">from </span><span>django.db </span><span style="color:#b48ead;">import </span><span>migrations
</span><span>
</span><span>
</span><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">Migration</span><span style="color:#eff1f5;">(</span><span style="color:#a3be8c;">migrations.Migration</span><span style="color:#eff1f5;">):
</span><span>
</span><span>    dependencies = [
</span><span>        (&quot;</span><span style="color:#a3be8c;">photos</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">0001_initial</span><span>&quot;),  </span><span style="color:#65737e;"># depends on your first migration
</span><span>    ]
</span><span>
</span><span>    operations = [
</span><span>        migrations.</span><span style="color:#bf616a;">RunSQL</span><span>(
</span><span>            </span><span style="color:#bf616a;">sql</span><span>=&quot;&quot;&quot;
</span><span style="color:#a3be8c;">            </span><span style="color:#b48ead;">ALTER TABLE </span><span style="color:#a3be8c;">photos
</span><span style="color:#a3be8c;">            ALTER COLUMN created </span><span style="color:#b48ead;">SET DEFAULT </span><span style="color:#96b5b4;">CURRENT_TIMESTAMP</span><span style="color:#a3be8c;">,
</span><span style="color:#a3be8c;">            ALTER COLUMN updated </span><span style="color:#b48ead;">SET DEFAULT </span><span style="color:#96b5b4;">CURRENT_TIMESTAMP</span><span style="color:#a3be8c;">;
</span><span style="color:#a3be8c;">
</span><span style="color:#a3be8c;">            </span><span style="color:#65737e;">-- Function to auto-update the &quot;updated&quot; column on UPDATE
</span><span style="color:#a3be8c;">            </span><span style="color:#b48ead;">CREATE OR REPLACE FUNCTION </span><span style="color:#8fa1b3;">update_updated_column</span><span style="color:#a3be8c;">()
</span><span style="color:#a3be8c;">            RETURNS TRIGGER </span><span>AS</span><span style="color:#a3be8c;"> $$
</span><span style="color:#a3be8c;">            </span><span style="color:#b48ead;">BEGIN
</span><span style="color:#a3be8c;">                </span><span style="color:#d08770;">NEW</span><span style="color:#a3be8c;">.</span><span style="color:#d08770;">updated </span><span>=</span><span style="color:#a3be8c;"> NOW();
</span><span style="color:#a3be8c;">                RETURN NEW;
</span><span style="color:#a3be8c;">            </span><span style="color:#b48ead;">END</span><span style="color:#a3be8c;">;
</span><span style="color:#a3be8c;">            $$ LANGUAGE plpgsql;
</span><span style="color:#a3be8c;">
</span><span style="color:#a3be8c;">            </span><span style="color:#65737e;">-- Trigger that calls the function on every update
</span><span style="color:#a3be8c;">            </span><span style="color:#b48ead;">DROP TRIGGER</span><span style="color:#a3be8c;"> IF </span><span>EXISTS</span><span style="color:#a3be8c;"> set_timestamp ON photos;
</span><span style="color:#a3be8c;">            </span><span style="color:#b48ead;">CREATE TRIGGER </span><span style="color:#8fa1b3;">set_timestamp
</span><span style="color:#a3be8c;">            BEFORE </span><span style="color:#b48ead;">UPDATE</span><span style="color:#a3be8c;"> ON photos
</span><span style="color:#a3be8c;">            FOR EACH ROW
</span><span style="color:#a3be8c;">            EXECUTE FUNCTION update_updated_column();
</span><span style="color:#a3be8c;">            </span><span>&quot;&quot;&quot;,
</span><span>            </span><span style="color:#bf616a;">reverse_sql</span><span>=&quot;&quot;&quot;
</span><span style="color:#a3be8c;">            DROP TRIGGER IF EXISTS set_timestamp ON photos;
</span><span style="color:#a3be8c;">            DROP FUNCTION IF EXISTS update_updated_column();
</span><span style="color:#a3be8c;">            ALTER TABLE photos
</span><span style="color:#a3be8c;">            ALTER COLUMN created DROP DEFAULT,
</span><span style="color:#a3be8c;">            ALTER COLUMN updated DROP DEFAULT;
</span><span style="color:#a3be8c;">            </span><span>&quot;&quot;&quot;,
</span><span>        ),
</span><span>    ]
</span></code></pre>
<p>Now run the migration command</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">python</span><span> manage.py migrate
</span></code></pre>
<p>Change the code in <code>load_data.py</code> file</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">import </span><span>io
</span><span style="color:#b48ead;">import </span><span>json
</span><span style="color:#b48ead;">from </span><span>django.db </span><span style="color:#b48ead;">import </span><span>connection
</span><span style="color:#b48ead;">from </span><span>typing </span><span style="color:#b48ead;">import </span><span>Iterator, Dict, Any
</span><span>
</span><span>@</span><span style="color:#bf616a;">profile
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">insert_string_io</span><span>(</span><span style="color:#bf616a;">photos</span><span>: Iterator[Dict[str, Any]]):
</span><span>    columns = (&quot;</span><span style="color:#a3be8c;">title</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">url</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">raw_data</span><span>&quot;)
</span><span>    csv_file_like_object = io.</span><span style="color:#bf616a;">StringIO</span><span>()
</span><span>    now = timezone.</span><span style="color:#bf616a;">now</span><span>().</span><span style="color:#bf616a;">isoformat</span><span>() </span><span style="color:#65737e;"># new
</span><span>    </span><span style="color:#b48ead;">for </span><span>photo </span><span style="color:#b48ead;">in </span><span>photos:
</span><span>        csv_file_like_object.</span><span style="color:#bf616a;">write</span><span>(
</span><span>            &quot;</span><span style="color:#a3be8c;">|</span><span>&quot;.</span><span style="color:#bf616a;">join</span><span>((photo[&quot;</span><span style="color:#a3be8c;">title</span><span>&quot;], photo[&quot;</span><span style="color:#a3be8c;">url</span><span>&quot;], json.</span><span style="color:#bf616a;">dumps</span><span>(photo))) + &quot;</span><span style="color:#96b5b4;">\n</span><span>&quot;
</span><span>        )
</span><span>    csv_file_like_object.</span><span style="color:#bf616a;">seek</span><span>(</span><span style="color:#d08770;">0</span><span>)
</span><span>    </span><span style="color:#b48ead;">with </span><span>connection.</span><span style="color:#bf616a;">cursor</span><span>() </span><span style="color:#b48ead;">as </span><span>cursor:
</span><span>        cursor.</span><span style="color:#bf616a;">copy_from</span><span>(csv_file_like_object, &quot;</span><span style="color:#a3be8c;">photos</span><span>&quot;, </span><span style="color:#bf616a;">sep</span><span>=&quot;</span><span style="color:#a3be8c;">|</span><span>&quot;, </span><span style="color:#bf616a;">columns</span><span>=columns)
</span></code></pre>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">python</span><span> manage.py load_data
</span><span>
</span><span style="color:#bf616a;">insert_string_io
</span><span style="color:#bf616a;">Time</span><span>   9.4409s
</span><span style="color:#bf616a;">Memory</span><span> 636.471 MiB (peak)
</span><span style="color:#bf616a;">Successfully</span><span> Loaded Data to Photos
</span></code></pre>
<p>As you can see, the execution time has not changed, but we are using slightly less memory.</p>
<h3 id="copy-data-from-a-string-iterator">Copy Data From a String Iterator</h3>
<p>One of the key limitations of using <code>COPY</code> with <code>StringIO</code> is that the entire dataset is first built and stored in memory, which can quickly become inefficient or even unmanageable for large imports. A more scalable approach is to create a streaming, <code>file-like</code> buffer that acts as an intermediary between the remote data source and the PostgreSQL <code>COPY</code> command. Instead of loading all data at once, this buffer would consume JSON records incrementally through an iterator, performing any necessary cleaning, validation, or transformation on each record before yielding a properly formatted CSV row. This streaming design dramatically reduces memory usage, improves performance on large datasets, and allows continuous ingestion of data without waiting for the entire file to be generated upfront.</p>
<div align="center">
<img src="/copy-diagram.svg" width="100%"/>
</div>
<p>You can refer to this <a href="https://stackoverflow.com/questions/12593576/adapt-an-iterator-to-behave-like-a-file-like-object-in-python/12604375#12604375">stack overflow answer</a> to created an object that feeds off an iterator, and provides a file-like interface:</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">from </span><span>typing </span><span style="color:#b48ead;">import </span><span>Iterator, Optional
</span><span style="color:#b48ead;">import </span><span>io
</span><span>
</span><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">StringIteratorIO</span><span style="color:#eff1f5;">(</span><span style="color:#a3be8c;">io.TextIOBase</span><span style="color:#eff1f5;">):
</span><span>    </span><span style="color:#b48ead;">def </span><span style="color:#96b5b4;">__init__</span><span>(</span><span style="color:#bf616a;">self</span><span>, </span><span style="color:#bf616a;">iter</span><span>: Iterator[str]):
</span><span>        </span><span style="color:#bf616a;">self</span><span>._iter = </span><span style="color:#96b5b4;">iter
</span><span>        </span><span style="color:#bf616a;">self</span><span>._buff = &#39;&#39;
</span><span>
</span><span>    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">readable</span><span>(</span><span style="color:#bf616a;">self</span><span>) -&gt; bool:
</span><span>        </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">True
</span><span>
</span><span>    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">_read1</span><span>(</span><span style="color:#bf616a;">self</span><span>, </span><span style="color:#bf616a;">n</span><span>: Optional[int] = </span><span style="color:#d08770;">None</span><span>) -&gt; str:
</span><span>        </span><span style="color:#b48ead;">while </span><span>not </span><span style="color:#bf616a;">self</span><span>._buff:
</span><span>            </span><span style="color:#b48ead;">try</span><span>:
</span><span>                </span><span style="color:#bf616a;">self</span><span>._buff = </span><span style="color:#96b5b4;">next</span><span>(</span><span style="color:#bf616a;">self</span><span>._iter)
</span><span>            </span><span style="color:#b48ead;">except </span><span>StopIteration:
</span><span>                </span><span style="color:#b48ead;">break
</span><span>        ret = </span><span style="color:#bf616a;">self</span><span>._buff[:n]
</span><span>        </span><span style="color:#bf616a;">self</span><span>._buff = </span><span style="color:#bf616a;">self</span><span>._buff[</span><span style="color:#96b5b4;">len</span><span>(ret):]
</span><span>        </span><span style="color:#b48ead;">return </span><span>ret
</span><span>
</span><span>    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">read</span><span>(</span><span style="color:#bf616a;">self</span><span>, </span><span style="color:#bf616a;">n</span><span>: Optional[int] = </span><span style="color:#d08770;">None</span><span>) -&gt; str:
</span><span>        line = []
</span><span>        </span><span style="color:#b48ead;">if </span><span>n is </span><span style="color:#d08770;">None </span><span>or n &lt; </span><span style="color:#d08770;">0</span><span>:
</span><span>            </span><span style="color:#b48ead;">while </span><span style="color:#d08770;">True</span><span>:
</span><span>                m = </span><span style="color:#bf616a;">self</span><span>.</span><span style="color:#bf616a;">_read1</span><span>()
</span><span>                </span><span style="color:#b48ead;">if </span><span>not m:
</span><span>                    </span><span style="color:#b48ead;">break
</span><span>                line.</span><span style="color:#bf616a;">append</span><span>(m)
</span><span>        </span><span style="color:#b48ead;">else</span><span>:
</span><span>            </span><span style="color:#b48ead;">while </span><span>n &gt; </span><span style="color:#d08770;">0</span><span>:
</span><span>                m = </span><span style="color:#bf616a;">self</span><span>.</span><span style="color:#bf616a;">_read1</span><span>(n)
</span><span>                </span><span style="color:#b48ead;">if </span><span>not m:
</span><span>                    </span><span style="color:#b48ead;">break
</span><span>                n -= </span><span style="color:#96b5b4;">len</span><span>(m)
</span><span>                line.</span><span style="color:#bf616a;">append</span><span>(m)
</span><span>        </span><span style="color:#b48ead;">return </span><span>&#39;&#39;.</span><span style="color:#bf616a;">join</span><span>(line)
</span></code></pre>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">import </span><span>io
</span><span style="color:#b48ead;">import </span><span>json
</span><span style="color:#b48ead;">from </span><span>django.db </span><span style="color:#b48ead;">import </span><span>connection
</span><span style="color:#b48ead;">from </span><span>typing </span><span style="color:#b48ead;">import </span><span>Iterator, Dict, Any
</span><span>@</span><span style="color:#bf616a;">profile
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">insert_buffer_string_io</span><span>(</span><span style="color:#bf616a;">photos</span><span>: Iterator[Dict[str, Any]]):
</span><span>    columns = (&quot;</span><span style="color:#a3be8c;">title</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">url</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">raw_data</span><span>&quot;)
</span><span>    csv_file_like_object = </span><span style="color:#bf616a;">StringIteratorIO</span><span>(
</span><span>        (&quot;</span><span style="color:#a3be8c;">|</span><span>&quot;.</span><span style="color:#bf616a;">join</span><span>((photo[&quot;</span><span style="color:#a3be8c;">title</span><span>&quot;], photo[&quot;</span><span style="color:#a3be8c;">url</span><span>&quot;], json.</span><span style="color:#bf616a;">dumps</span><span>(photo)))) + &quot;</span><span style="color:#96b5b4;">\n</span><span>&quot;
</span><span>        </span><span style="color:#b48ead;">for </span><span>photo </span><span style="color:#b48ead;">in </span><span>photos
</span><span>    )
</span><span>    </span><span style="color:#b48ead;">with </span><span>connection.</span><span style="color:#bf616a;">cursor</span><span>() </span><span style="color:#b48ead;">as </span><span>cursor:
</span><span>        cursor.</span><span style="color:#bf616a;">copy_from</span><span>(csv_file_like_object, &quot;</span><span style="color:#a3be8c;">photos</span><span>&quot;, </span><span style="color:#bf616a;">sep</span><span>=&quot;</span><span style="color:#a3be8c;">|</span><span>&quot;, </span><span style="color:#bf616a;">columns</span><span>=columns)
</span></code></pre>
<blockquote>
<p>Here we didn't add <code>created</code> and <code>updated</code> to the comumns neither the values beacuse we had made a SQL migration before, so if you stock with the pythonic way the function should look like this:</p>
</blockquote>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">import </span><span>io
</span><span style="color:#b48ead;">import </span><span>json
</span><span style="color:#b48ead;">from </span><span>django.db </span><span style="color:#b48ead;">import </span><span>connection
</span><span style="color:#b48ead;">from </span><span>django.utils </span><span style="color:#b48ead;">import </span><span>timezone  </span><span style="color:#65737e;"># new
</span><span style="color:#b48ead;">from </span><span>typing </span><span style="color:#b48ead;">import </span><span>Iterator, Dict, Any
</span><span>
</span><span>@</span><span style="color:#bf616a;">profile
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">insert_buffer_string_io</span><span>(</span><span style="color:#bf616a;">photos</span><span>: Iterator[Dict[str, Any]]):
</span><span>    columns = (&quot;</span><span style="color:#a3be8c;">title</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">url</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">raw_data</span><span>&quot;,&quot;</span><span style="color:#a3be8c;">created</span><span>&quot;,&quot;</span><span style="color:#a3be8c;">updated</span><span>&quot;)
</span><span>	now = timezone.</span><span style="color:#bf616a;">now</span><span>().</span><span style="color:#bf616a;">isoformat</span><span>() </span><span style="color:#65737e;"># new
</span><span>    csv_file_like_object = </span><span style="color:#bf616a;">StringIteratorIO</span><span>(
</span><span>        (&quot;</span><span style="color:#a3be8c;">|</span><span>&quot;.</span><span style="color:#bf616a;">join</span><span>((photo[&quot;</span><span style="color:#a3be8c;">title</span><span>&quot;], photo[&quot;</span><span style="color:#a3be8c;">url</span><span>&quot;], json.</span><span style="color:#bf616a;">dumps</span><span>(photo), now, now))) + &quot;</span><span style="color:#96b5b4;">\n</span><span>&quot;
</span><span>        </span><span style="color:#b48ead;">for </span><span>photo </span><span style="color:#b48ead;">in </span><span>photos
</span><span>    )
</span><span>    </span><span style="color:#b48ead;">with </span><span>connection.</span><span style="color:#bf616a;">cursor</span><span>() </span><span style="color:#b48ead;">as </span><span>cursor:
</span><span>        cursor.</span><span style="color:#bf616a;">copy_from</span><span>(csv_file_like_object, &quot;</span><span style="color:#a3be8c;">photos</span><span>&quot;, </span><span style="color:#bf616a;">sep</span><span>=&quot;</span><span style="color:#a3be8c;">|</span><span>&quot;, </span><span style="color:#bf616a;">columns</span><span>=columns)
</span></code></pre>
<p>Change the <code>load_data.py</code>command</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">Command</span><span style="color:#eff1f5;">(</span><span style="color:#a3be8c;">BaseCommand</span><span style="color:#eff1f5;">):
</span><span>    </span><span style="color:#96b5b4;">help </span><span>= &quot;</span><span style="color:#a3be8c;">Load Data from External API</span><span>&quot;
</span><span>
</span><span>    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">handle</span><span>(</span><span style="color:#bf616a;">self</span><span>, *</span><span style="color:#bf616a;">args</span><span>, **</span><span style="color:#bf616a;">options</span><span>):
</span><span>        </span><span style="color:#65737e;"># insert_django_bulk_create(photos=photos)
</span><span>        </span><span style="color:#65737e;">#insert_string_io(photos=photos)
</span><span>		</span><span style="color:#bf616a;">insert_buffer_string_io</span><span>(</span><span style="color:#bf616a;">photos</span><span>=photos)
</span><span>        </span><span style="color:#bf616a;">self</span><span>.stdout.</span><span style="color:#bf616a;">write</span><span>(</span><span style="color:#bf616a;">self</span><span>.style.</span><span style="color:#bf616a;">SUCCESS</span><span>(&quot;</span><span style="color:#a3be8c;">Successful</span><span style="background-color:#bf616a;color:#2b303b;">
</span></code></pre>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">python</span><span> manage.py load_data   
</span><span>
</span><span style="color:#bf616a;">insert_buffer_string_io
</span><span style="color:#bf616a;">Time</span><span>   8.6109s
</span><span style="color:#bf616a;">Memory</span><span> 0.022 MiB (peak)
</span></code></pre>
<p>The insert_buffer_string_io operation completed in <strong>8.6109</strong> seconds and reached a peak memory usage of only <strong>0.022</strong> MiB. This means the process took a moderate amount of time to execute but was extremely memory-efficient. The low memory footprint suggests that data was handled incrementally—likely using a streaming or buffered approach—rather than being fully loaded into memory at once.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">psql</span><span> (18.0 (Debian 18.0-1.pgdg13+3))
</span><span style="color:#bf616a;">Type </span><span>&quot;</span><span style="color:#a3be8c;">help</span><span>&quot; for help.
</span><span>
</span><span style="color:#bf616a;">django</span><span>=</span><span style="color:#a3be8c;"># </span><span style="color:#bf616a;">select</span><span> count(id) </span><span style="color:#bf616a;">from</span><span> photos;
</span><span> </span><span style="color:#bf616a;">count  
</span><span style="color:#bf616a;">--------
</span><span> </span><span style="color:#bf616a;">500000
</span><span>(</span><span style="color:#bf616a;">1</span><span> row)
</span></code></pre>
<h3 id="github-repo">Github Repo</h3>
<p><a href="https://github.com/malnossi/djangopostgrescopy">Source Code</a></p>
<h3 id="conclusion">Conclusion</h3>
<p>You might wonder which approach to choose and, as always, the honest answer is "it depends". The key takeaway is to stay aware of the potential side effects that could impact your project.</p>
<p>Here are a few important considerations:</p>
<ul>
<li>If you’re working with multiple databases or complex routing, ensure that your Django model is connected to the correct database.</li>
<li>Copy operations do not trigger Django model signals such as <code>pre_save</code> or <code>post_save</code>.</li>
<li>Despite these caveats, using <code>copy_from</code> methods offers a substantial performance boost over <code>bulk_create</code>, which itself is already faster than inserting records one by one.</li>
</ul>
<p><strong>This article was inspired by <a href="https://hakibenita.com/fast-load-data-python-postgresql">Haki Benita's article</a>, so thank you to him for his wonderful work.</strong></p>

          </div>
        </div>
      </div>
</div>

    <footer class="footer">
    <div class="has-text-centered">
        Mohamed AL NOSSIRAT <span id="date"></span>
    </div>
</footer>
<script lang="js">
    window.onload = () => {
        const date = new Date().getFullYear()
        document.querySelector("#date").textContent = date;
    }
</script>
    <script lang="js" src='https://malnossi.github.io/script.js'></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8LBRDGLXJV" defer></script>
    <script defer>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-8LBRDGLXJV');
    </script>
</body>

</html>